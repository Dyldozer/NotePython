# Simple WebSocket Client in PowerShell
# Works with wss://echo.websocket.events

Add-Type -AssemblyName System.Net.WebSockets
Add-Type -AssemblyName System.Runtime

$url = "wss://echo.websocket.events"
$ws = [System.Net.WebSockets.ClientWebSocket]::new()

Write-Host "Connecting to $url ..."
$ws.ConnectAsync([Uri]$url, [Threading.CancellationToken]::None).Wait()

if ($ws.State -ne [System.Net.WebSockets.WebSocketState]::Open) {
    Write-Host "‚ùå Failed to connect."
    exit
}

Write-Host "‚úÖ Connected!"

# Convert string message to byte[]
$message = "Hello from PowerShell!"
$buffer = [System.Text.Encoding]::UTF8.GetBytes($message)
$segment = [ArraySegment[byte]]::new($buffer)

# Send message
$ws.SendAsync($segment, [System.Net.WebSockets.WebSocketMessageType]::Text, $true, [Threading.CancellationToken]::None).Wait()
Write-Host "‚û°Ô∏è Sent: $message"

# Receive response
$receiveBuffer = New-Object byte[] 4096
$receiveSegment = [ArraySegment[byte]]::new($receiveBuffer)

$result = $ws.ReceiveAsync($receiveSegment, [Threading.CancellationToken]::None).Result
$response = [System.Text.Encoding]::UTF8.GetString($receiveBuffer, 0, $result.Count)

Write-Host "‚¨ÖÔ∏è Received: $response"

# Close connection
$ws.CloseAsync([System.Net.WebSockets.WebSocketCloseStatus]::NormalClosure, "Done", [Threading.CancellationToken]::None).Wait()
$ws.Dispose()

Write-Host "üîí Connection closed."
