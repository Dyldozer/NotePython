$ws = [System.Net.WebSockets.ClientWebSocket]::new()
$uri = [Uri]"wss://echo.websocket.events"
$ws.ConnectAsync($uri, [Threading.CancellationToken]::None).Wait()

$msg = "Hello from PS7!"
$bytes = [System.Text.Encoding]::UTF8.GetBytes($msg)
$segment = [ArraySegment[byte]]::new($bytes)
$ws.SendAsync($segment, [System.Net.WebSockets.WebSocketMessageType]::Text, $true, [Threading.CancellationToken]::None).Wait()

$buffer = [byte[]]::new(4096)
$seg = [ArraySegment[byte]]::new($buffer)
$result = $ws.ReceiveAsync($seg, [Threading.CancellationToken]::None).Result
$response = [System.Text.Encoding]::UTF8.GetString($buffer, 0, $result.Count)
Write-Host "Received: $response"

$ws.Dispose()
